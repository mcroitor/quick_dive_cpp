# Использование сторонних библиотек

- [Использование сторонних библиотек](#использование-сторонних-библиотек)
  - [библиотека программирования](#библиотека-программирования)
  - [использование статических библиотек](#использование-статических-библиотек)
    - [Пример использования статической библиотеки](#пример-использования-статической-библиотеки)
  - [использование динамических библиотек](#использование-динамических-библиотек)
  - [неявное связывание](#неявное-связывание)
    - [явное связывание](#явное-связывание)
  - [Библиография](#библиография)

## библиотека программирования

Под __библиотекой программирования__ понимают архив ресурсов программирования, таких как функции, классы, объекты, константы и различные переменные. В частности, константами могут быть заданы графические или мультимедийные данные. Библиотеки программирования делятся на три типа: __статические__, __динамические__ и __библиотеки шаблонов__.

Статические библиотеки представляются двумя файлами:

1. Заголовочный файл с расширением `h` (`hxx`, `hpp`), описывающий интерфейс библиотеки;
2. Бинарный архив с расширением `lib` (в Windows) или `а` (в Unix совместимых системах), хранящий все ресурсы программирования в виде объектного кода.

Динамические библиотеки представляются тремя файлами:

1. Заголовочный файл с расширением `h` (`hxx`, `hpp`), описывающий интерфейс библиотеки;
2. Бинарный архив с расширением `dll` (в Windows) или `so` (в Unix совместимых системах), называемый динамической (в Unix системах - разделяемой) библиотекой, и хранящий все ресурсы программирования в виде бинарного кода.
3. файл с расширением `lib` (в Windows) или `а` (в Unix совместимых системах), называемый библиотекой импорта и хранящий места расположения ресурсов программирования в динамической библиотеке. В Unix системах библиотека импорта не используется.

Существует также определённый тип библиотек, которые не могут быть представимы иначе как в виде исходного кода – это библиотеки, содержащие шаблоны классов и функций. Эти библиотеки поставляются в заголовочных файлах.

Наименование файлов библиотек программирования для компилятора Gnu C++ (g++) имеет следующий вид:

- заголовочный файл: `<имя библиотеки>.h` или `<имя библиотеки>.hpp`;
- статическая библиотека: `lib<имя библиотеки>.a` (в Unix системах) или `<имя библиотеки>.lib` (в Windows);
- динамическая библиотека: `<имя библиотеки>.so` (в Unix системах) или `<имя библиотеки>.dll` (в Windows).

Заголовочные файлы обычно содержатся в папке `INCLUDE` компилятора, статические библиотеки и библиотеки импорта – в папке `LIB`, динамические библиотеки содержаться в системных папках ( `c:\\Windows\System32` или `/usr/bin`). Эти пути можно переопределить в программе либо на этапе компиляции.

Каждый тип библиотеки программирования имеет свои преимущества и недостатки. Например, использование статических библиотек повышает переносимость программ за счет того, что они не зависят от каких-либо модулей (динамических библиотек), однако код программы вырастает. Использование динамических библиотек позволяет создавать маленькие по объёму программы, однако в процессе выполнения они будут занимать в оперативной памяти место динамической библиотекой.

## использование статических библиотек

При использовании функций (классов или других программных ресурсов) статических библиотек, на этапе компиляции программы из библиотеки компилятор берёт только объектные коды используемых ресурсов. Поэтому, при размере статической библиотеки в несколько мегабайт, программа вырастает в объёме на несколько десятков килобайт (в зависимости от размера используемых функций).

Для использования статической библиотеки в программе необходимо выполнить следующие действия:

1. Подключить заголовочный файл библиотеки в программу;
2. При компиляции программы указать путь к библиотеке в параметрах компиляции.

В данном случае компилятор берёт только объектные коды используемых функций из библиотеки и включает их в программный код. Данное включение кода называется __статической компоновкой__.

### Пример использования статической библиотеки

Пусть имеется статическая библиотека __MyMath__, которая характеризуется следующими файлами:

1. `MyMath.h` - заголовочный файл библиотеки;
2. `libMyMath.a` - бинарный архив библиотеки.

Пусть данная библиотека содержится в папке `C:\MyLibs\MyMath`. Для использования библиотеки в программе необходимо выполнить следующие действия:

1. Подключить заголовочный файл библиотеки в программу:

```cpp
#include "MyMath.h"
```

2. При компиляции программы указать путь к библиотеке в параметрах компиляции:

```bash
g++ -o MyProgram.exe MyProgram.cpp -IC:\MyLibs\MyMath -LC:\MyLibs\MyMath -lMyMath
```

В данном случае ключ компиляции `-I` указывает путь к заголовочным файлам библиотеки, ключ `-L` указывает путь к библиотекам программирования, а ключ `-l` указывает имя библиотеки.

## использование динамических библиотек

Динамические библиотеки могут использоваться двумя различными способами:

- Неявное связывание;
- Явное связывание.

## неявное связывание

__Неявное связывание библиотеки__ с приложением происходит при подключении заголовочного файла, а также при указании в свойствах проекта использования библиотеки. В этом случае библиотека будет загружаться в оперативную память перед запуском приложения. В случае запуска приложения операционная система проверяет наличие динамических библиотек, связанных с программой, по системным путям, в текущей директории или в оперативной памяти. Только после этого программа выполняется. Если же хотя бы одна библиотека не была найдена, то приложение завершается с соответствующей ошибкой.

При компиляции программы, использующей динамическую библиотеку, исполняемый код программы вырастает в размере на несколько байт, так как вместо бинарного кода функции из динамической библиотеки в программу включается вызов этой функции из библиотеки, объявленный в библиотеке импорта.

### явное связывание

Однако, динамические библиотеки также могут быть загружены не только при запуске программы, но и, по требованию, в момент выполнения программы.

__Явное связывание библиотеки__ осуществляется при помощи функции `LoadLibrary` (`dlopen` в Unix системах), которая загружает библиотеку в момент вызова функции. В этом случае приложение может работать без библиотеки до того момента, пока не будет она загружена функцией `LoadLibrary`.

В операционных системах Windows для явного связывания библиотеки используются следующие функции, объявленные в заголовочном файле `windows.h`:

- `LoadLibrary` - загружает динамическую библиотеку в оперативную память;
- `GetProcAddress` - получает адрес функции из динамической библиотеки;
- `FreeLibrary` - выгружает динамическую библиотеку из оперативной памяти.
- `GetModuleHandle` - получает дескриптор динамической библиотеки.

В Unix системах для явного связывания библиотеки используются следующие функции, объявленные в заголовочном файле `dlfcn.h`:

- `dlopen` - загружает динамическую библиотеку в оперативную память;
- `dlsym` - получает адрес функции из динамической библиотеки;
- `dlclose` - выгружает динамическую библиотеку из оперативной памяти;

Если существует динамическая библиотека `MyMath.dll`, а в ней определена функция `int Add(int, int)`, то в ОС Windows, для явного связывания библиотеки с программой необходимо выполнить следующие действия:

```cpp
#include <windows.h>
#include <iostream>

typedef int (*pOperation)(int, int);

int main()
{
    HINSTANCE hLib = LoadLibrary("MyMath.dll");
    if (hLib == NULL)
    {
        std::cerr << "Error loading library" << std::endl;
        return 1;
    }

    pOperation Add = (pOperation)GetProcAddress(hLib, "Add");
    if (Add == NULL)
    {
        std::cerr << "Error loading function" << std::endl;
        return 1;
    }

    std::cout << Add(2, 3) << std::endl;

    FreeLibrary(hLib);
    return 0;
}
```

В Unix системах для явного связывания библиотеки с программой необходимо выполнить следующие действия:

```cpp
#include <dlfcn.h>
#include <iostream>

typedef int (*pOperation)(int, int);

int main()
{
    void* hLib = dlopen("MyMath.so", RTLD_LAZY);
    if (hLib == NULL)
    {
        std::cerr << "Error loading library" << std::endl;
        return 1;
    }

    pOperation Add = (pOperation)dlsym(hLib, "Add");
    if (Add == NULL)
    {
        std::cerr << "Error loading function" << std::endl;
        return 1;
    }

    std::cout << Add(2, 3) << std::endl;

    dlclose(hLib);
    return 0;
}
```

## Библиография

1. [Библиотека (программирование), Wikipedia](https://ru.wikipedia.org/wiki/Библиотека_(программирование))
2. [Создание библиотек DLL на C и C++ в Visual Studio, microsoft.com](https://learn.microsoft.com/ru-ru/cpp/build/dlls-in-visual-cpp?view=msvc-170)
3. [dlopen, Linux Manual page](https://www.man7.org/linux/man-pages/man3/dlopen.3.html)
4. [Wheeler David, Dynamically Loaded (DL) Libraries](https://dwheeler.com/program-library/)
